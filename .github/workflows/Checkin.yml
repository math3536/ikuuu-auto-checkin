name: IKUUU-Auto-Checkin

on:
  workflow_dispatch:
  schedule:
    - cron: "*/5 * * * *" # UTC 00:00 = åŒ—äº¬æ—¶é—´ 08:00

jobs:
  checkin:
    name: Checkin
    runs-on: ubuntu-latest

    env:
      ACCOUNTS: ${{ secrets.ACCOUNTS }}
      HOST: ${{ secrets.HOST }}
      TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
      TELEGRAM_TO: ${{ secrets.TELEGRAM_TO }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: latest

      - name: Checkin
        id: checkin
        shell: bash
        run: |
          set -u

          # 1) ç”ŸæˆåŒ—äº¬æ—¶é—´ï¼ˆä¸€å®šæœ‰å€¼ï¼‰
          run_time="$(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S')"
          echo "run_time=$run_time" >> "$GITHUB_OUTPUT"

          # 2) è·‘è„šæœ¬å¹¶æŠ“è¾“å‡ºï¼ˆä¸è®© workflow å› è„šæœ¬é0ç›´æ¥ä¸­æ–­ï¼Œä¿è¯èƒ½å†™ outputï¼‰
          output="$(node main.js 2>&1 || true)"
          echo "$output"

          # 3) å†™å…¥å¤šè¡Œ outputï¼šresult
          {
            echo "result<<EOF"
            echo "$output"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Notify
        if: ${{ always() && env.TELEGRAM_TOKEN && env.TELEGRAM_TO }}
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          format: markdown
          message: |
            âœ… *IKUUU ç­¾åˆ°é€šçŸ¥*
            â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
            â± ç­¾åˆ°æ—¶é—´ï¼š${{ steps.checkin.outputs.run_time }}
            ğŸ“Š ç­¾åˆ°ç»“æœï¼š
            ${{ steps.checkin.outputs.result }}
